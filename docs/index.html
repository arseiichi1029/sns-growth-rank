<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SNS Growth Rank</title>
  <link rel="stylesheet" href="./styles.css?v=2" />
  <meta name="description" content="Wikipedia急上昇 / Google Trends を自動更新で並べる" />
</head>
<body data-theme="wiki">
  <div class="wrap">
    <div class="header">
      <div class="logo">
        <div class="logoMark" aria-hidden="true"></div>
        <div>
          <h1>SNS Growth Rank</h1>
          <p class="subtitle">請求ゼロ（GitHub Pages + GitHub Actions）</p>
        </div>
      </div>

      <div class="tabs">
        <button class="btn active" id="tabWiki" type="button">Wikipedia 急上昇</button>
        <button class="btn" id="tabTrends" type="button">Google Trends</button>
      </div>
    </div>

    <!-- ad slot (top) -->
    <div class="ad" id="ad-top">AD PLACEHOLDER (top)</div>

    <div class="metaRow">
      <div><span class="badge" id="metaLeft">ja</span></div>
      <div><span class="badge" id="metaRight">updated: -</span></div>
    </div>

    <div class="panel">
      <div class="notice" id="notice">loading...</div>
      <div class="list" id="list"></div>
    </div>

    <!-- ad slot (bottom) -->
    <div class="ad" id="ad-bottom">AD PLACEHOLDER (bottom)</div>

    <div class="footer">
      <div>data: <span id="dataPath">-</span></div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

const PATHS = {
  wiki: './data/wiki.json',
  trends: './data/trends_google.json',
};

function setActive(mode){
  document.body.setAttribute('data-theme', mode);
  $('tabWiki').classList.toggle('active', mode === 'wiki');
  $('tabTrends').classList.toggle('active', mode === 'trends');
  $('metaLeft').textContent = mode === 'wiki' ? 'Wikipedia / ja' : 'Google Trends / ja';
  $('dataPath').textContent = (mode === 'wiki') ? PATHS.wiki : PATHS.trends;
}

function fmtViews(n){
  if (n === 0) return '0 views';
  if (!n) return '-';
  return new Intl.NumberFormat('en-US').format(n) + ' views';
}

function clearList(){
  $('list').innerHTML = '';
}

function renderItems(mode, items){
  clearList();
  const frag = document.createDocumentFragment();
  items.slice(0, 50).forEach((it, i) => {
    const rank = it.rank ?? (i+1);
    const title = it.title ?? it.query ?? it.name ?? '(no title)';
    const url = it.url ?? it.link ?? '';
    const views = it.views ?? it.value ?? 0;

    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div class="rank">#${rank}</div>
      <div>
        <div class="title">${escapeHtml(title)}</div>
        <div class="url">${escapeHtml(url)}</div>
      </div>
      <div class="value">${mode === 'wiki' ? fmtViews(views) : '0 views'}</div>
    `;
    row.addEventListener('click', () => { if (url) window.open(url, '_blank', 'noopener'); });
    frag.appendChild(row);
  });
  $('list').appendChild(frag);
}

function showNotice(kind, text){
  const n = $('notice');
  n.className = 'notice ' + (kind || '');
  n.textContent = text;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

async function load(mode){
  setActive(mode);
  showNotice('', 'loading...');
  clearList();

  const url = (mode === 'wiki' ? PATHS.wiki : PATHS.trends) + '?v=' + Date.now();
  try{
    const res = await fetch(url, { cache: 'no-store' });
    const json = await res.json();

    $('metaRight').textContent = 'updated: ' + (json.updatedAt || '-');

    if (!json.ok){
      showNotice('err', 'error: ' + (json.error || 'unknown'));
      return;
    }

    const items = json.items || [];
    showNotice('ok', 'loaded: ' + items.length);
    renderItems(mode, items);
  }catch(e){
    showNotice('err', 'error: ' + (e && e.message ? e.message : String(e)));
  }
}

$('tabWiki').addEventListener('click', ()=>load('wiki'));
$('tabTrends').addEventListener('click', ()=>load('trends'));

load('wiki');
</script>
</body>
</html>
